name: Twitch Clip to YouTube Shorts

on:
  workflow_dispatch:
    inputs:
      streamer:
        description: 'Twitch streamer username'
        required: true
        default: 'jynxzi'  # default streamer
        
      header_text:
        description: 'Top text shown above the video (Shorts hook)'
        required: true
        default: 'We Post Jynxzi Clip Everyday'  # default header text

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1 Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3️ Install dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests google-auth-oauthlib google-api-python-client ffmpeg-python yt-dlp

      # 3.5 Install ffmpeg binary
      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      # 3.6 Create clips folder
      - name: Create clips folder
        run: |
          mkdir -p clips

      # 4️ Download Twitch clip
      - name: Download Twitch clip
        id: get_clip
        run: |
          python scripts/get_clip.py "${{ github.event.inputs.streamer }}"
        env:
          TWITCH_CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }}
          TWITCH_CLIENT_SECRET: ${{ secrets.TWITCH_CLIENT_SECRET }}

      # 5️ Convert to vertical 9:16
      - name: Convert clip to vertical
        env:
          HEADER_TEXT: ${{ github.event.inputs.header_text }}
          STREAMER_NAME: ${{ github.event.inputs.streamer }}
        run: |
          echo "CLIP_PATH is: '$CLIP_PATH'"

          ls -l clips
      
          if [ -z "$CLIP_PATH" ]; then
            echo "ERROR: CLIP_PATH is empty"
            exit 1
          fi
      
          TEMP_FILE="${CLIP_PATH%.mp4}_vertical.mp4"
      
          ffmpeg -y -i "$CLIP_PATH" \
            -vf "
              scale=720:1280:force_original_aspect_ratio=decrease,
              pad=720:1280:(ow-iw)/2:(oh-ih)/2:color=black,
              drawtext=text='${HEADER_TEXT}':fontcolor=white:fontsize=56:x=(w-text_w)/2:y=300:box=1:boxcolor=black@0.5:boxborderw=12,
              drawtext=text='@${STREAMER_NAME}':fontcolor=white:fontsize=42:x=(w-text_w)/2:y=h-300
            " \
            -c:a copy \
            "$TEMP_FILE"

      
          mv "$TEMP_FILE" "$CLIP_PATH"

      # 6️ Upload to YouTube
      - name: Upload to YouTube
        run: |
          python scripts/upload_youtube.py "clips/$(basename "$CLIP_PATH")"
        env:
          JYNXZI_YOUTUBE_CLIENT_ID: ${{ secrets.JYNXZI_YOUTUBE_CLIENT_ID }}
          JYNXZI_YOUTUBE_CLIENT_SECRET: ${{ secrets.JYNXZI_YOUTUBE_CLIENT_SECRET }}
          JYNXZI_YOUTUBE_REFRESH_TOKEN: ${{ secrets.JYNXZI_YOUTUBE_REFRESH_TOKEN }}
