name: Twitch Clip to YouTube Shorts

on:
  workflow_dispatch:
    inputs:
      streamer:
        description: 'Twitch streamer username'
        required: true
        default: 'jynxzi'  # default streamer

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

            # 3️⃣ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests google-auth-oauthlib google-api-python-client ffmpeg-python yt-dlp

      # 4️⃣ Download Twitch clip
      - name: Download Twitch clip
        run: |
          python scripts/get_clip.py "${{ github.event.inputs.streamer }}"
        env:
          TWITCH_CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }}
          TWITCH_CLIENT_SECRET: ${{ secrets.TWITCH_CLIENT_SECRET }}

      # 5️⃣ Convert to vertical 9:16
      - name: Convert clip to vertical
        run: |
          ffmpeg -i clips/latest_clip.mp4 -vf "scale=720:1280:force_original_aspect_ratio=decrease,pad=720:1280:(ow-iw)/2:(oh-ih)/2" clips/vertical_clip.mp4

      # 6️⃣ Upload to YouTube
      - name: Upload to YouTube
        run: |
          python scripts/upload_youtube.py clips/vertical_clip.mp4
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.JYNXZI_YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.JYNXZI_YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.JYNXZI_YOUTUBE_REFRESH_TOKEN }}
